<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Alert System - Greenhouse</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .danger-btn {
            background-color: #dc3545;
        }
        .danger-btn:hover {
            background-color: #c82333;
        }
        .warning-btn {
            background-color: #ffc107;
            color: #212529;
        }
        .warning-btn:hover {
            background-color: #e0a800;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .sensor-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .sensor-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .threshold-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .threshold-input {
            display: flex;
            flex-direction: column;
        }
        .threshold-input label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .threshold-input input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test Alert System - Greenhouse</h1>
        <p>C√¥ng c·ª• n√†y gi√∫p test h·ªá th·ªëng c·∫£nh b√°o d·ª±a tr√™n ng∆∞·ª°ng c·∫£m bi·∫øn</p>

        <div class="test-section info">
            <h3>üìã H∆∞·ªõng d·∫´n Test</h3>
            <ol>
                <li>M·ªü Dashboard t·∫°i <a href="http://localhost:3000/dashboard" target="_blank">http://localhost:3000/dashboard</a></li>
                <li>M·ªü Management t·∫°i <a href="http://localhost:3000/management" target="_blank">http://localhost:3000/management</a></li>
                <li>Chuy·ªÉn sang tab "C·∫£nh b√°o" ƒë·ªÉ c·∫•u h√¨nh ng∆∞·ª°ng</li>
                <li>S·ª≠ d·ª•ng c√°c button d∆∞·ªõi ƒë√¢y ƒë·ªÉ m√¥ ph·ªèng d·ªØ li·ªáu c·∫£m bi·∫øn</li>
                <li>Quan s√°t c·∫£nh b√°o xu·∫•t hi·ªán trong Dashboard</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üéõÔ∏è C·∫•u h√¨nh ng∆∞·ª°ng c·∫£nh b√°o</h3>
            <p>Thi·∫øt l·∫≠p ng∆∞·ª°ng ƒë·ªÉ test c·∫£nh b√°o:</p>
            <div class="threshold-controls">
                <div class="threshold-input">
                    <label>Nhi·ªát ƒë·ªô - C·∫£nh b√°o (¬∞C)</label>
                    <input type="number" id="temp-warning" value="30" min="0" max="50">
                </div>
                <div class="threshold-input">
                    <label>Nhi·ªát ƒë·ªô - Nguy hi·ªÉm (¬∞C)</label>
                    <input type="number" id="temp-danger" value="35" min="0" max="50">
                </div>
                <div class="threshold-input">
                    <label>ƒê·ªô ·∫©m - C·∫£nh b√°o (%)</label>
                    <input type="number" id="humidity-warning" value="80" min="0" max="100">
                </div>
                <div class="threshold-input">
                    <label>ƒê·ªô ·∫©m - Nguy hi·ªÉm (%)</label>
                    <input type="number" id="humidity-danger" value="90" min="0" max="100">
                </div>
                <div class="threshold-input">
                    <label>ƒê·ªô ·∫©m ƒë·∫•t - C·∫£nh b√°o (%)</label>
                    <input type="number" id="soil-warning" value="20" min="0" max="100">
                </div>
                <div class="threshold-input">
                    <label>ƒê·ªô ·∫©m ƒë·∫•t - Nguy hi·ªÉm (%)</label>
                    <input type="number" id="soil-danger" value="10" min="0" max="100">
                </div>
                <div class="threshold-input">
                    <label>√Ånh s√°ng - C·∫£nh b√°o (lux)</label>
                    <input type="number" id="light-warning" value="9000" min="0" max="20000">
                </div>
                <div class="threshold-input">
                    <label>√Ånh s√°ng - Nguy hi·ªÉm (lux)</label>
                    <input type="number" id="light-danger" value="9500" min="0" max="20000">
                </div>
            </div>
            <button onclick="saveAlertConfig()">üíæ L∆∞u c·∫•u h√¨nh ng∆∞·ª°ng</button>
            <div id="saveResult"></div>
        </div>

        <div class="test-section">
            <h3>üìä Tr·∫°ng th√°i c·∫£m bi·∫øn hi·ªán t·∫°i</h3>
            <div class="sensor-display">
                <div class="sensor-card">
                    <h4>üå°Ô∏è Nhi·ªát ƒë·ªô</h4>
                    <div id="current-temp">--¬∞C</div>
                </div>
                <div class="sensor-card">
                    <h4>üíß ƒê·ªô ·∫©m</h4>
                    <div id="current-humidity">--%</div>
                </div>
                <div class="sensor-card">
                    <h4>üå± ƒê·ªô ·∫©m ƒë·∫•t</h4>
                    <div id="current-soil">--%</div>
                </div>
                <div class="sensor-card">
                    <h4>‚òÄÔ∏è √Ånh s√°ng</h4>
                    <div id="current-light">-- lux</div>
                </div>
            </div>
            <button onclick="refreshSensorData()">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
        </div>

        <div class="test-section">
            <h3>üß™ M√¥ ph·ªèng d·ªØ li·ªáu c·∫£m bi·∫øn</h3>
            <p>G·ª≠i d·ªØ li·ªáu test ƒë·ªÉ k√≠ch ho·∫°t c·∫£nh b√°o:</p>
            
            <h4>Nhi·ªát ƒë·ªô:</h4>
            <button onclick="sendSensorData('temperature', 25)">üü¢ B√¨nh th∆∞·ªùng (25¬∞C)</button>
            <button class="warning-btn" onclick="sendSensorData('temperature', 32)">üü° C·∫£nh b√°o (32¬∞C)</button>
            <button class="danger-btn" onclick="sendSensorData('temperature', 38)">üî¥ Nguy hi·ªÉm (38¬∞C)</button>
            
            <h4>ƒê·ªô ·∫©m:</h4>
            <button onclick="sendSensorData('humidity', 70)">üü¢ B√¨nh th∆∞·ªùng (70%)</button>
            <button class="warning-btn" onclick="sendSensorData('humidity', 85)">üü° C·∫£nh b√°o (85%)</button>
            <button class="danger-btn" onclick="sendSensorData('humidity', 95)">üî¥ Nguy hi·ªÉm (95%)</button>
            
            <h4>ƒê·ªô ·∫©m ƒë·∫•t:</h4>
            <button onclick="sendSensorData('soil_moisture', 60)">üü¢ B√¨nh th∆∞·ªùng (60%)</button>
            <button class="warning-btn" onclick="sendSensorData('soil_moisture', 18)">üü° C·∫£nh b√°o (18%)</button>
            <button class="danger-btn" onclick="sendSensorData('soil_moisture', 8)">üî¥ Nguy hi·ªÉm (8%)</button>
            
            <h4>C∆∞·ªùng ƒë·ªô √°nh s√°ng:</h4>
            <button onclick="sendSensorData('light_intensity', 7000)">üü¢ B√¨nh th∆∞·ªùng (7000 lux)</button>
            <button class="warning-btn" onclick="sendSensorData('light_intensity', 9200)">üü° C·∫£nh b√°o (9200 lux)</button>
            <button class="danger-btn" onclick="sendSensorData('light_intensity', 9800)">üî¥ Nguy hi·ªÉm (9800 lux)</button>
            
            <h4>C√°c t√¨nh hu·ªëng kh√°c:</h4>
            <button onclick="sendRandomData()">üé≤ D·ªØ li·ªáu ng·∫´u nhi√™n</button>
            <button onclick="sendNormalData()">‚úÖ D·ªØ li·ªáu b√¨nh th∆∞·ªùng</button>
            <button onclick="sendMultipleAlerts()">‚ö†Ô∏è Nhi·ªÅu c·∫£nh b√°o c√πng l√∫c</button>
            
            <div id="testResult"></div>
        </div>

        <div class="test-section">
            <h3>üîç Ki·ªÉm tra LocalStorage</h3>
            <button onclick="checkAlertConfig()">Xem c·∫•u h√¨nh c·∫£nh b√°o</button>
            <button onclick="clearAlertConfig()">X√≥a c·∫•u h√¨nh c·∫£nh b√°o</button>
            <div id="localStorageResult"></div>
        </div>
    </div>

    <script>
        // G·ª≠i d·ªØ li·ªáu c·∫£m bi·∫øn test
        async function sendSensorData(sensorType, value) {
            try {
                const response = await fetch('/api/sensors/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sensor_type: sensorType,
                        value: value,
                        device_id: 'test-device-1'
                    }),
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('testResult').innerHTML = 
                        `<div class="success">‚úÖ ƒê√£ g·ª≠i ${sensorType}: ${value}</div>`;
                    refreshSensorData();
                } else {
                    document.getElementById('testResult').innerHTML = 
                        `<div class="error">‚ùå L·ªói: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div class="error">‚ùå L·ªói k·∫øt n·ªëi: ${error.message}</div>`;
            }
        }

        // G·ª≠i nhi·ªÅu d·ªØ li·ªáu ng·∫´u nhi√™n
        async function sendRandomData() {
            const sensors = [
                { type: 'temperature', value: Math.random() * 50 },
                { type: 'humidity', value: Math.random() * 100 },
                { type: 'soil_moisture', value: Math.random() * 100 },
                { type: 'light_intensity', value: Math.random() * 15000 }
            ];

            for (const sensor of sensors) {
                await sendSensorData(sensor.type, Math.round(sensor.value * 10) / 10);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }

        // G·ª≠i d·ªØ li·ªáu b√¨nh th∆∞·ªùng
        async function sendNormalData() {
            await sendSensorData('temperature', 25);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('humidity', 65);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('soil_moisture', 45);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('light_intensity', 6000);
        }

        // G·ª≠i nhi·ªÅu c·∫£nh b√°o c√πng l√∫c
        async function sendMultipleAlerts() {
            await sendSensorData('temperature', 40);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('humidity', 95);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('soil_moisture', 5);
            await new Promise(resolve => setTimeout(resolve, 200));
            await sendSensorData('light_intensity', 10000);
        }

        // L√†m m·ªõi d·ªØ li·ªáu c·∫£m bi·∫øn
        async function refreshSensorData() {
            try {
                const response = await fetch('/api/sensors/latest');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('current-temp').textContent = 
                        data.temperature ? `${data.temperature.toFixed(1)}¬∞C` : '--¬∞C';
                    document.getElementById('current-humidity').textContent = 
                        data.humidity ? `${data.humidity.toFixed(1)}%` : '--%';
                    document.getElementById('current-soil').textContent = 
                        data.soil_moisture ? `${data.soil_moisture.toFixed(1)}%` : '--%';
                    document.getElementById('current-light').textContent = 
                        data.light_intensity ? `${data.light_intensity.toFixed(0)} lux` : '-- lux';
                }
            } catch (error) {
                console.error('Error refreshing sensor data:', error);
            }
        }

        // L∆∞u c·∫•u h√¨nh c·∫£nh b√°o
        function saveAlertConfig() {
            const alertConfig = {
                temperature: {
                    warning: parseInt(document.getElementById('temp-warning').value),
                    danger: parseInt(document.getElementById('temp-danger').value),
                    enabled: true
                },
                humidity: {
                    warning: parseInt(document.getElementById('humidity-warning').value),
                    danger: parseInt(document.getElementById('humidity-danger').value),
                    enabled: true
                },
                soilMoisture: {
                    warning: parseInt(document.getElementById('soil-warning').value),
                    danger: parseInt(document.getElementById('soil-danger').value),
                    enabled: true
                },
                light: {
                    warning: parseInt(document.getElementById('light-warning').value),
                    danger: parseInt(document.getElementById('light-danger').value),
                    enabled: true
                }
            };

            localStorage.setItem('alert-config', JSON.stringify(alertConfig));
            document.getElementById('saveResult').innerHTML = 
                '<div class="success">‚úÖ C·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o LocalStorage</div>';
        }

        // Ki·ªÉm tra c·∫•u h√¨nh c·∫£nh b√°o trong LocalStorage
        function checkAlertConfig() {
            const alertConfig = localStorage.getItem('alert-config');
            const result = document.getElementById('localStorageResult');
            
            if (alertConfig) {
                try {
                    const config = JSON.parse(alertConfig);
                    let html = '<h4>üìã C·∫•u h√¨nh c·∫£nh b√°o hi·ªán t·∫°i:</h4>';
                    html += `<pre>${JSON.stringify(config, null, 2)}</pre>`;
                    result.innerHTML = `<div class="success">${html}</div>`;
                } catch (e) {
                    result.innerHTML = `<div class="error">‚ùå L·ªói parse JSON: ${e.message}</div>`;
                }
            } else {
                result.innerHTML = '<div class="error">‚ùå Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh c·∫£nh b√°o</div>';
            }
        }

        // X√≥a c·∫•u h√¨nh c·∫£nh b√°o
        function clearAlertConfig() {
            localStorage.removeItem('alert-config');
            document.getElementById('localStorageResult').innerHTML = 
                '<div class="success">‚úÖ ƒê√£ x√≥a c·∫•u h√¨nh c·∫£nh b√°o</div>';
        }

        // T·ª± ƒë·ªông l√†m m·ªõi d·ªØ li·ªáu khi t·∫£i trang
        window.onload = function() {
            refreshSensorData();
            // T·ª± ƒë·ªông l√†m m·ªõi m·ªói 5 gi√¢y
            setInterval(refreshSensorData, 5000);
        };
    </script>
</body>
</html>
